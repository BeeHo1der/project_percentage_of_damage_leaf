import sys
import cv2
import numpy as np
import os
from datetime import datetime
from typing import List, Tuple, Dict, Optional

from PyQt5.QtWidgets import *
from PyQt5.QtCore import *
from PyQt5.QtGui import *


class LeafDiseaseAnalyzer:
    def __init__(self, pixels_per_cm: float = 62.0, min_leaf_area_cm: float = 1.0):
        self.pixels_per_cm = pixels_per_cm
        self.min_leaf_area_cm = min_leaf_area_cm
        
        # –î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –∑–¥–æ—Ä–æ–≤—ã—Ö –ª–∏—Å—Ç—å–µ–≤ (–∑–µ–ª–µ–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏)
        self.healthy_ranges = {
            'green_light': {'lower': [25, 20, 50], 'upper': [85, 255, 255]},
            'green_dark': {'lower': [25, 20, 20], 'upper': [95, 255, 180]},
            'green_yellowish': {'lower': [20, 20, 40], 'upper': [45, 255, 255]},
        }
        
        # –î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π
        self.damage_ranges = {
            'yellow': {'lower': [15, 40, 100], 'upper': [35, 255, 255]},      # –Ø—Ä–∫–æ-–∂–µ–ª—Ç—ã–µ
            'brown_1': {'lower': [0, 30, 30], 'upper': [20, 255, 150]},       # –ö–æ—Ä–∏—á–Ω–µ–≤—ã–µ
            'brown_2': {'lower': [160, 30, 30], 'upper': [180, 255, 150]},    # –ö—Ä–∞—Å–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–µ
            'white': {'lower': [0, 0, 200], 'upper': [180, 40, 255]},         # –ë–µ–ª—ã–µ
            'necrotic': {'lower': [0, 0, 0], 'upper': [180, 255, 50]},        # –ß–µ—Ä–Ω—ã–µ/—Ç–µ–º–Ω—ã–µ
        }

    def preprocess_image(self, image_path: str) -> Tuple[np.ndarray, np.ndarray]:
        """–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
        img = cv2.imread(image_path)
        if img is None:
            raise FileNotFoundError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {image_path}")
        
        # –ò–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        height, width = img.shape[:2]
        if width > 1000:
            scale = 1000 / width
            new_size = (int(width * scale), int(height * scale))
            img = cv2.resize(img, new_size)
        
        original = img.copy()
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ HSV
        hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)
        
        return original, hsv

    def create_mask(self, hsv: np.ndarray, ranges: Dict) -> np.ndarray:
        """–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Å–∫–∏ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤"""
        combined_mask = np.zeros(hsv.shape[:2], dtype=np.uint8)
        
        for name, range_dict in ranges.items():
            lower = np.array(range_dict['lower'])
            upper = np.array(range_dict['upper'])
            mask = cv2.inRange(hsv, lower, upper)
            combined_mask = cv2.bitwise_or(combined_mask, mask)
        
        # –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        kernel = np.ones((3, 3), np.uint8)
        combined_mask = cv2.morphologyEx(combined_mask, cv2.MORPH_OPEN, kernel)
        combined_mask = cv2.morphologyEx(combined_mask, cv2.MORPH_CLOSE, kernel)
        
        return combined_mask

    def find_leaves(self, mask: np.ndarray) -> List[Tuple[np.ndarray, float, float]]:
        """–ü–æ–∏—Å–∫ –ª–∏—Å—Ç—å–µ–≤ –ø–æ –º–∞—Å–∫–µ"""
        # –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç—É—Ä—ã
        contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
        
        leaf_info = []
        debug_info = []
        
        for i, contour in enumerate(contours):
            area_px = cv2.contourArea(contour)
            area_cm = area_px / (self.pixels_per_cm ** 2)
            
            debug_info.append(f"–ö–æ–Ω—Ç—É—Ä {i+1}: {area_px:.0f} –ø–∏–∫—Å = {area_cm:.2f} —Å–º¬≤")
            
            if area_cm >= self.min_leaf_area_cm:
                # –°–≥–ª–∞–∂–∏–≤–∞–µ–º –∫–æ–Ω—Ç—É—Ä
                epsilon = 0.01 * cv2.arcLength(contour, True)
                approx = cv2.approxPolyDP(contour, epsilon, True)
                leaf_info.append((approx, area_px, area_cm))
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–ª–æ—â–∞–¥–∏
        leaf_info.sort(key=lambda x: x[1], reverse=True)
        
        return leaf_info, debug_info

    def analyze_leaf(self, contour: np.ndarray, 
                    healthy_mask: np.ndarray,
                    damage_mask: np.ndarray) -> Dict:
        """–ê–Ω–∞–ª–∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞"""
        
        # –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –ª–∏—Å—Ç–∞
        leaf_mask = np.zeros_like(healthy_mask)
        cv2.drawContours(leaf_mask, [contour], -1, 255, -1)
        
        # –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å –ª–∏—Å—Ç–∞
        total_area_px = cv2.contourArea(contour)
        total_area_cm = total_area_px / (self.pixels_per_cm ** 2)
        
        # –ó–¥–æ—Ä–æ–≤—ã–µ —É—á–∞—Å—Ç–∫–∏ (–∑–µ–ª–µ–Ω—ã–µ)
        healthy_pixels = cv2.bitwise_and(healthy_mask, leaf_mask)
        healthy_area_px = cv2.countNonZero(healthy_pixels)
        healthy_area_cm = healthy_area_px / (self.pixels_per_cm ** 2)
        
        # –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏
        damaged_pixels = cv2.bitwise_and(damage_mask, leaf_mask)
        damaged_area_px = cv2.countNonZero(damaged_pixels)
        damaged_area_cm = damaged_area_px / (self.pixels_per_cm ** 2)
        
        # –ü—Ä–æ—Ü–µ–Ω—Ç—ã
        if total_area_px > 0:
            healthy_percent = (healthy_area_px / total_area_px) * 100
            damaged_percent = (damaged_area_px / total_area_px) * 100
        else:
            healthy_percent = 0
            damaged_percent = 0
        
        return {
            'total_area_cm': total_area_cm,
            'healthy_area_cm': healthy_area_cm,
            'damaged_area_cm': damaged_area_cm,
            'healthy_percent': healthy_percent,
            'damaged_percent': damaged_percent,
            'leaf_mask': leaf_mask,
            'healthy_mask': healthy_pixels,
            'damage_mask': damaged_pixels
        }

    def analyze_image(self, image_path: str) -> Dict:
        """–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
            original, hsv = self.preprocess_image(image_path)
            
            # –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫–∏
            healthy_mask = self.create_mask(hsv, self.healthy_ranges)
            damage_mask = self.create_mask(hsv, self.damage_ranges)
            
            # –£–±–∏—Ä–∞–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –∏–∑ –∑–¥–æ—Ä–æ–≤–æ–π –º–∞—Å–∫–∏
            pure_healthy = cv2.bitwise_and(healthy_mask, cv2.bitwise_not(damage_mask))
            
            # –ù–∞—Ö–æ–¥–∏–º –ª–∏—Å—Ç—å—è
            leaf_info, debug_info = self.find_leaves(pure_healthy)
            
            # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å–∫–∏
            mask_viz = np.zeros((original.shape[0], original.shape[1], 3), dtype=np.uint8)
            mask_viz[pure_healthy > 0] = [0, 255, 0]      # –ó–¥–æ—Ä–æ–≤—ã–µ - –∑–µ–ª–µ–Ω—ã–π
            mask_viz[damage_mask > 0] = [0, 0, 255]       # –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è - –∫—Ä–∞—Å–Ω—ã–π
            
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –ª–∏—Å—Ç
            results_list = []
            total_healthy = 0
            total_damaged = 0
            total_area = 0
            
            for contour, area_px, area_cm in leaf_info:
                leaf_result = self.analyze_leaf(contour, pure_healthy, damage_mask)
                results_list.append(leaf_result)
                total_healthy += leaf_result['healthy_area_cm']
                total_damaged += leaf_result['damaged_area_cm']
                total_area += leaf_result['total_area_cm']
            
            # –û–±—â–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
            if total_area > 0:
                overall_healthy = (total_healthy / total_area) * 100
                overall_damaged = (total_damaged / total_area) * 100
            else:
                overall_healthy = 0
                overall_damaged = 0
            
            # –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            visualization = self.create_visualization(original, leaf_info, results_list)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            debug_text = "üîç –û–¢–õ–ê–î–ö–ê\n" + "="*30 + "\n"
            debug_text += f"–í—Å–µ–≥–æ –∫–æ–Ω—Ç—É—Ä–æ–≤: {len(debug_info)}\n"
            for line in debug_info:
                debug_text += line + "\n"
            debug_text += f"\n–ù–∞–π–¥–µ–Ω–æ –ª–∏—Å—Ç—å–µ–≤: {len(leaf_info)}"
            
            return {
                'total_leaves': len(results_list),
                'leaves': results_list,
                'total_area_cm': total_area,
                'total_healthy_cm': total_healthy,
                'total_damaged_cm': total_damaged,
                'healthy_percent': overall_healthy,
                'damaged_percent': overall_damaged,
                'debug_info': debug_text,
                'visualization': visualization,
                'mask_viz': mask_viz
            }
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            import traceback
            traceback.print_exc()
            raise

    def create_visualization(self, img: np.ndarray, leaf_info: List, results: List) -> np.ndarray:
        """–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏"""
        vis = img.copy()
        
        # –°–æ–∑–¥–∞–µ–º —Ü–≤–µ—Ç–Ω—ã–µ overlay
        healthy_overlay = np.zeros_like(vis)
        damaged_overlay = np.zeros_like(vis)
        
        for i, (contour, area_px, area_cm) in enumerate(leaf_info):
            if i < len(results):
                result = results[i]
                
                # –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∑–¥–æ—Ä–æ–≤—ã–µ —É—á–∞—Å—Ç–∫–∏ (–∑–µ–ª–µ–Ω—ã–º)
                if 'healthy_mask' in result:
                    healthy_overlay[result['healthy_mask'] > 0] = [0, 255, 0]
                
                # –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ (–∫—Ä–∞—Å–Ω—ã–º)
                if 'damage_mask' in result:
                    damaged_overlay[result['damage_mask'] > 0] = [0, 0, 255]
                
                # –†–∏—Å—É–µ–º –∫–æ–Ω—Ç—É—Ä
                color = (255, 255, 255)  # –ë–µ–ª—ã–π –∫–æ–Ω—Ç—É—Ä
                cv2.drawContours(vis, [contour], -1, color, 2)
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                M = cv2.moments(contour)
                if M['m00'] != 0:
                    cx = int(M['m10'] / M['m00'])
                    cy = int(M['m01'] / M['m00'])
                    
                    # –§–æ–Ω –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                    cv2.rectangle(vis, (cx-70, cy-35), (cx+70, cy+15), (0, 0, 0), -1)
                    
                    # –¢–µ–∫—Å—Ç —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
                    text1 = f"L{i+1}: {result['total_area_cm']:.1f}—Å–º¬≤"
                    text2 = f"–ó–¥:{result['healthy_percent']:.0f}% –ü–æ–≤:{result['damaged_percent']:.0f}%"
                    
                    cv2.putText(vis, text1, (cx-65, cy-20),
                               cv2.FONT_HERSHEY_SIMPLEX, 0.35, (255, 255, 255), 1)
                    cv2.putText(vis, text2, (cx-65, cy),
                               cv2.FONT_HERSHEY_SIMPLEX, 0.35, (255, 255, 255), 1)
        
        # –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —Ü–≤–µ—Ç–Ω—ã–µ –º–∞—Å–∫–∏ —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
        cv2.addWeighted(healthy_overlay, 0.3, vis, 1.0, 0, vis)
        cv2.addWeighted(damaged_overlay, 0.5, vis, 1.0, 0, vis)
        
        # –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        if results:
            total_damage = sum(r['damaged_percent'] for r in results) / len(results)
            total_healthy = sum(r['healthy_percent'] for r in results) / len(results)
            info = f"–õ–∏—Å—Ç—å–µ–≤: {len(results)} | –ó–¥–æ—Ä–æ–≤—å–µ: {total_healthy:.0f}% | –ü–æ—Ä–∞–∂–µ–Ω–∏–µ: {total_damage:.0f}%"
            
            cv2.rectangle(vis, (10, 10), (350, 35), (0, 0, 0), -1)
            cv2.putText(vis, info, (15, 30),
                       cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 255, 255), 1)
        
        return vis


class LeafDiseaseAnalyzerGUI(QMainWindow):
    def __init__(self):
        super().__init__()
        self.analyzer = None
        self.current_image_path = None
        self.results = None
        self.initUI()
    
    def initUI(self):
        self.setWindowTitle('üçÉ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ª–∏—Å—Ç—å–µ–≤ v5.0 (–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è)')
        self.setGeometry(100, 100, 1400, 800)
        
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        main_layout = QHBoxLayout()
        central_widget.setLayout(main_layout)
        
        # –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å
        left_panel = self.create_left_panel()
        main_layout.addWidget(left_panel)
        
        # –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –≤–∫–ª–∞–¥–∫–∞–º–∏
        right_panel = self.create_right_panel()
        main_layout.addWidget(right_panel)
        
        self.status_bar = QStatusBar()
        self.setStatusBar(self.status_bar)
        self.status_bar.showMessage('‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ')
    
    def create_left_panel(self):
        panel = QWidget()
        panel.setMaximumWidth(400)
        layout = QVBoxLayout()
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title = QLabel('üçÉ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ª–∏—Å—Ç—å–µ–≤')
        title.setStyleSheet('''
            font-size: 20px; font-weight: bold; color: #27ae60;
            padding: 15px; background-color: #f0f8f0;
            border-radius: 8px; border-left: 5px solid #27ae60;
        ''')
        layout.addWidget(title)
        
        # –ö–Ω–æ–ø–∫–∏
        btn_layout = QVBoxLayout()
        
        self.load_btn = QPushButton('üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ')
        self.load_btn.setStyleSheet(self.get_button_style('#3498db', '#2980b9'))
        self.load_btn.clicked.connect(self.load_image)
        btn_layout.addWidget(self.load_btn)
        
        self.analyze_btn = QPushButton('üî¨ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å')
        self.analyze_btn.setStyleSheet(self.get_button_style('#27ae60', '#229954'))
        self.analyze_btn.clicked.connect(self.analyze)
        self.analyze_btn.setEnabled(False)
        btn_layout.addWidget(self.analyze_btn)
        
        layout.addLayout(btn_layout)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ
        info_group = QGroupBox('üìÑ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è')
        info_layout = QVBoxLayout()
        self.file_info = QLabel('–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω')
        self.file_info.setWordWrap(True)
        self.file_info.setStyleSheet('padding: 10px; background-color: #f8f9fa; border-radius: 5px;')
        info_layout.addWidget(self.file_info)
        info_group.setLayout(info_layout)
        layout.addWidget(info_group)
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
        params_group = QGroupBox('‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã')
        params_layout = QFormLayout()
        
        self.ppc_spin = QDoubleSpinBox()
        self.ppc_spin.setRange(10, 200)
        self.ppc_spin.setValue(62.0)
        self.ppc_spin.setSuffix(' px/—Å–º')
        params_layout.addRow('–ü–∏–∫—Å–µ–ª–µ–π/—Å–º:', self.ppc_spin)
        
        self.min_area_spin = QDoubleSpinBox()
        self.min_area_spin.setRange(0.1, 20)
        self.min_area_spin.setValue(0.5)
        self.min_area_spin.setSuffix(' —Å–º¬≤')
        params_layout.addRow('–ú–∏–Ω. –ø–ª–æ—â–∞–¥—å:', self.min_area_spin)
        
        params_group.setLayout(params_layout)
        layout.addWidget(params_group)
        
        # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
        results_group = QGroupBox('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã')
        results_layout = QVBoxLayout()
        self.results_text = QTextEdit()
        self.results_text.setReadOnly(True)
        self.results_text.setMaximumHeight(150)
        self.results_text.setStyleSheet('font-family: monospace; font-size: 12px; background-color: #f8f9fa;')
        results_layout.addWidget(self.results_text)
        results_group.setLayout(results_layout)
        layout.addWidget(results_group)
        
        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        debug_group = QGroupBox('üêõ –û—Ç–ª–∞–¥–∫–∞')
        debug_layout = QVBoxLayout()
        self.debug_text = QTextEdit()
        self.debug_text.setReadOnly(True)
        self.debug_text.setMaximumHeight(150)
        self.debug_text.setStyleSheet('font-family: monospace; font-size: 10px; background-color: #2d2d2d; color: #ffffff;')
        debug_layout.addWidget(self.debug_text)
        debug_group.setLayout(debug_layout)
        layout.addWidget(debug_group)
        
        # –ü—Ä–æ–≥—Ä–µ—Å—Å
        self.progress = QProgressBar()
        self.progress.hide()
        layout.addWidget(self.progress)
        
        layout.addStretch()
        panel.setLayout(layout)
        return panel
    
    def create_right_panel(self):
        panel = QTabWidget()
        panel.setMinimumWidth(900)
        
        # –í–∫–ª–∞–¥–∫–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
        result_tab = QWidget()
        result_layout = QVBoxLayout()
        
        self.result_label = QLabel()
        self.result_label.setAlignment(Qt.AlignCenter)
        self.result_label.setStyleSheet('border: 1px solid #dee2e6; background-color: #f8f9fa; min-height: 600px;')
        self.result_label.setText('–ê–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω')
        result_layout.addWidget(self.result_label)
        
        result_tab.setLayout(result_layout)
        panel.addTab(result_tab, 'üìà –†–µ–∑—É–ª—å—Ç–∞—Ç')
        
        # –í–∫–ª–∞–¥–∫–∞ —Å –º–∞—Å–∫–∞–º–∏
        mask_tab = QWidget()
        mask_layout = QVBoxLayout()
        
        self.mask_label = QLabel()
        self.mask_label.setAlignment(Qt.AlignCenter)
        self.mask_label.setStyleSheet('border: 1px solid #dee2e6; background-color: #f8f9fa; min-height: 600px;')
        self.mask_label.setText('–ú–∞—Å–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞')
        mask_layout.addWidget(self.mask_label)
        
        mask_tab.setLayout(mask_layout)
        panel.addTab(mask_tab, 'üé® –ú–∞—Å–∫–∏ (–ó–µ–ª–µ–Ω—ã–π=–∑–¥–æ—Ä–æ–≤, –ö—Ä–∞—Å–Ω—ã–π=–ø–æ–≤—Ä–µ–∂–¥)')
        
        # –í–∫–ª–∞–¥–∫–∞ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º
        original_tab = QWidget()
        original_layout = QVBoxLayout()
        
        self.original_label = QLabel()
        self.original_label.setAlignment(Qt.AlignCenter)
        self.original_label.setStyleSheet('border: 1px solid #dee2e6; background-color: #f8f9fa; min-height: 600px;')
        self.original_label.setText('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ')
        original_layout.addWidget(self.original_label)
        
        original_tab.setLayout(original_layout)
        panel.addTab(original_tab, 'üñº –û—Ä–∏–≥–∏–Ω–∞–ª')
        
        # –í–∫–ª–∞–¥–∫–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
        history_tab = QWidget()
        history_layout = QVBoxLayout()
        
        self.history_list = QListWidget()
        self.history_list.setIconSize(QSize(60, 60))
        self.history_list.itemClicked.connect(self.load_from_history)
        history_layout.addWidget(self.history_list)
        
        self.clear_btn = QPushButton('üóë –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é')
        self.clear_btn.clicked.connect(self.clear_history)
        history_layout.addWidget(self.clear_btn)
        
        history_tab.setLayout(history_layout)
        panel.addTab(history_tab, 'üìã –ò—Å—Ç–æ—Ä–∏—è')
        
        return panel
    
    def get_button_style(self, color, hover):
        return f'''
            QPushButton {{
                background-color: {color}; color: white; font-size: 14px; font-weight: bold;
                padding: 15px; border-radius: 8px; margin: 5px; border: none;
            }}
            QPushButton:hover {{ background-color: {hover}; border: 2px solid white; }}
            QPushButton:disabled {{ background-color: #bdc3c7; }}
        '''
    
    def load_image(self):
        file_path, _ = QFileDialog.getOpenFileName(
            self, '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', os.path.expanduser("~"),
            '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (*.png *.jpg *.jpeg *.bmp *.tiff);;–í—Å–µ —Ñ–∞–π–ª—ã (*.*)'
        )
        
        if file_path:
            try:
                test_img = cv2.imread(file_path)
                if test_img is None:
                    QMessageBox.critical(self, '‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ')
                    return
                
                self.current_image_path = file_path
                self.display_image(file_path, self.original_label)
                
                file_name = os.path.basename(file_path)
                file_size = os.path.getsize(file_path) / 1024
                file_size_str = f"{file_size:.1f} KB" if file_size < 1024 else f"{file_size/1024:.2f} MB"
                
                self.file_info.setText(f'üìÅ {file_name}\nüìè {file_size_str}')
                self.analyze_btn.setEnabled(True)
                self.status_bar.showMessage(f'‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {file_name}')
                
            except Exception as e:
                QMessageBox.critical(self, '‚ùå –û—à–∏–±–∫–∞', f'–û—à–∏–±–∫–∞: {str(e)}')
    
    def display_image(self, image_path, label_widget):
        try:
            pixmap = QPixmap(image_path)
            if not pixmap.isNull():
                scaled = pixmap.scaled(800, 600, Qt.KeepAspectRatio, Qt.SmoothTransformation)
                label_widget.setPixmap(scaled)
                label_widget.setText("")
        except:
            label_widget.setText("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏")
    
    def display_mask(self, mask_img):
        try:
            if mask_img is not None:
                rgb = cv2.cvtColor(mask_img, cv2.COLOR_BGR2RGB)
                h, w, ch = rgb.shape
                qt_img = QImage(rgb.data, w, h, ch * w, QImage.Format_RGB888)
                pixmap = QPixmap.fromImage(qt_img)
                scaled = pixmap.scaled(800, 600, Qt.KeepAspectRatio, Qt.SmoothTransformation)
                self.mask_label.setPixmap(scaled)
                self.mask_label.setText("")
        except:
            self.mask_label.setText("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Å–∫–∏")
    
    def analyze(self):
        if not self.current_image_path:
            return
        
        try:
            self.progress.show()
            self.progress.setValue(0)
            self.status_bar.showMessage('üîÑ –ê–Ω–∞–ª–∏–∑...')
            
            self.analyzer = LeafDiseaseAnalyzer(
                pixels_per_cm=self.ppc_spin.value(),
                min_leaf_area_cm=self.min_area_spin.value()
            )
            
            self.progress.setValue(30)
            QApplication.processEvents()
            
            self.results = self.analyzer.analyze_image(self.current_image_path)
            
            self.progress.setValue(80)
            QApplication.processEvents()
            
            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            if 'visualization' in self.results:
                self.display_analysis_result(self.results['visualization'])
            
            if 'mask_viz' in self.results:
                self.display_mask(self.results['mask_viz'])
            
            if 'debug_info' in self.results:
                self.debug_text.setText(self.results['debug_info'])
            
            self.display_results()
            self.add_to_history()
            
            self.progress.setValue(100)
            self.status_bar.showMessage('‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω')
            
        except Exception as e:
            QMessageBox.critical(self, '‚ùå –û—à–∏–±–∫–∞', f'–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:\n{str(e)}')
            self.debug_text.setText(f"–û–®–ò–ë–ö–ê: {str(e)}")
        finally:
            self.progress.hide()
    
    def display_analysis_result(self, vis_img):
        try:
            rgb = cv2.cvtColor(vis_img, cv2.COLOR_BGR2RGB)
            h, w, ch = rgb.shape
            qt_img = QImage(rgb.data, w, h, ch * w, QImage.Format_RGB888)
            pixmap = QPixmap.fromImage(qt_img)
            scaled = pixmap.scaled(800, 600, Qt.KeepAspectRatio, Qt.SmoothTransformation)
            self.result_label.setPixmap(scaled)
            self.result_label.setText("")
        except:
            self.result_label.setText("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
    
    def display_results(self):
        if not self.results:
            return
        
        leaves = self.results.get('total_leaves', 0)
        total = self.results.get('total_area_cm', 0.0)
        healthy = self.results.get('total_healthy_cm', 0.0)
        damaged = self.results.get('total_damaged_cm', 0.0)
        healthy_pct = self.results.get('healthy_percent', 0.0)
        damaged_pct = self.results.get('damaged_percent', 0.0)
        
        text = [
            "üçÉ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê",
            "=" * 35,
            f"üìä –õ–∏—Å—Ç—å–µ–≤: {leaves}",
            f"üìê –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å: {total:.1f} —Å–º¬≤",
            f"üü¢ –ó–¥–æ—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥—å: {healthy:.1f} —Å–º¬≤ ({healthy_pct:.1f}%)",
            f"üî¥ –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–∞—è –ø–ª–æ—â–∞–¥—å: {damaged:.1f} —Å–º¬≤ ({damaged_pct:.1f}%)",
            f"‚ö†Ô∏è –û–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ—Ä–∞–∂–µ–Ω–∏—è: {damaged_pct:.1f}%"
        ]
        
        if leaves > 0:
            text.append("")
            text.append("üìä –ü–û –õ–ò–°–¢–¨–Ø–ú:")
            for i, leaf in enumerate(self.results.get('leaves', [])):
                text.append(f"  –õ–∏—Å—Ç {i+1}: {leaf['total_area_cm']:.1f}—Å–º¬≤, "
                          f"–ó–¥:{leaf['healthy_percent']:.0f}%, "
                          f"–ü–æ–≤:{leaf['damaged_percent']:.0f}%")
        
        self.results_text.setText('\n'.join(text))
    
    def add_to_history(self):
        filename = os.path.basename(self.current_image_path)
        date = datetime.now().strftime("%d.%m.%Y %H:%M")
        
        pixmap = QPixmap(self.current_image_path)
        icon = QIcon() if pixmap.isNull() else QIcon(QPixmap.fromImage(pixmap.scaled(60, 60).toImage()))
        
        leaves = self.results.get('total_leaves', 0)
        damaged = self.results.get('damaged_percent', 0.0)
        text = f"{filename}\nüìÖ {date}\nüçÉ {leaves} –ª–∏—Å—Ç. | ‚ö†Ô∏è {damaged:.1f}%"
        
        item = QListWidgetItem()
        item.setText(text)
        item.setIcon(icon)
        item.setData(Qt.UserRole, {
            'filename': filename,
            'date': date,
            'image_path': self.current_image_path,
            'results': self.results
        })
        
        self.history_list.insertItem(0, item)
    
    def load_from_history(self, item):
        data = item.data(Qt.UserRole)
        if data:
            self.current_image_path = data['image_path']
            self.results = data['results']
            
            self.display_image(self.current_image_path, self.original_label)
            if 'visualization' in self.results:
                self.display_analysis_result(self.results['visualization'])
            if 'mask_viz' in self.results:
                self.display_mask(self.results['mask_viz'])
            self.display_results()
            
            self.file_info.setText(f'üìÅ {data["filename"]}\nüìÖ {data["date"]}')
            self.analyze_btn.setEnabled(True)
    
    def clear_history(self):
        reply = QMessageBox.question(self, '–û—á–∏—Å—Ç–∫–∞', '–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?',
                                   QMessageBox.Yes | QMessageBox.No)
        if reply == QMessageBox.Yes:
            self.history_list.clear()


def main():
    app = QApplication.instance()
    if app is None:
        app = QApplication(sys.argv)
    
    window = LeafDiseaseAnalyzerGUI()
    window.show()
    return app.exec_()


if __name__ == '__main__':
    try:
        from IPython import get_ipython
        if get_ipython() is not None:
            print("üöÄ –ó–ê–ü–£–°–ö –í JUPYTER")
            print("=" * 50)
            print("‚úÖ –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å —Ä–∞—Å—á–µ—Ç–æ–º –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤!")
            print("üìä –ó–µ–ª–µ–Ω—ã–π = –∑–¥–æ—Ä–æ–≤—ã–µ —É—á–∞—Å—Ç–∫–∏")
            print("üî¥ –ö—Ä–∞—Å–Ω—ã–π = –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è")
            print("=" * 50)
            
            import threading
            def run_app():
                app = QApplication.instance()
                if app is None:
                    app = QApplication(sys.argv)
                window = LeafDiseaseAnalyzerGUI()
                window.show()
                app.exec_()
            
            thread = threading.Thread(target=run_app)
            thread.daemon = True
            thread.start()
        else:
            sys.exit(main())
    except ImportError:
        sys.exit(main())
